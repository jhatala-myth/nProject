<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ project.name }} - Project Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .task-item {
            border-left: 3px solid #007bff;
            transition: background-color 0.2s;
        }
        .task-item:hover {
            background-color: #f8f9fa;
        }
        .task-metadata {
            font-size: 0.85rem;
            color: #6c757d;
        }
        .task-progress {
            margin-top: 8px;
        }
        .progress {
            height: 8px;
            background-color: #e9ecef;
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
        .task-subtasks-section {
            margin-top: 12px;
        }
        .subtask-bar {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 8px 10px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .subtask-bar:hover {
            background-color: #e9ecef;
        }
        .subtask-bar.expanded {
            background-color: #fff;
            border-color: #6c757d;
        }
        .subtask-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .subtask-title {
            flex: 1;
            font-weight: 500;
            font-size: 0.9rem;
        }
        .subtask-actions {
            display: flex;
            gap: 4px;
            margin-left: 8px;
        }
        .subtask-actions button {
            opacity: 0.6;
        }
        .subtask-bar:hover .subtask-actions button {
            opacity: 1;
        }
        .subtask-expand-icon {
            transition: transform 0.2s;
            font-size: 1rem;
            color: #6c757d;
            margin-left: 8px;
        }
        .subtask-bar.expanded .subtask-expand-icon {
            transform: rotate(90deg);
        }
        .subtask-content {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #dee2e6;
            display: none;
        }
        .subtask-bar.expanded .subtask-content {
            display: block;
        }
        .task-last-comment {
            margin-top: 8px;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        .task-last-comment-author {
            font-weight: 600;
            color: #495057;
        }
        .task-last-comment-text {
            color: #6c757d;
            font-style: italic;
        }
        .subtask-item {
            border-left: 3px solid #6c757d;
            margin-left: 2rem;
        }
        .comment-box {
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .comment-bar {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px 12px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }
        .comment-bar:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }
        .comment-bar.expanded {
            background-color: #fff;
            border-color: #0d6efd;
        }
        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .comment-title {
            font-weight: 600;
            margin: 0;
            flex: 1;
            min-width: 0;
        }
        .comment-title-text {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: block;
        }
        .comment-title-preview {
            font-size: 0.85rem;
            color: #6c757d;
            font-weight: normal;
            margin-top: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .comment-header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .comment-actions {
            display: flex;
            gap: 4px;
        }
        .comment-actions button {
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .comment-bar:hover .comment-actions button {
            opacity: 1;
        }
        .comment-expand-icon {
            transition: transform 0.2s;
            font-size: 1.2rem;
            color: #6c757d;
        }
        .comment-bar.expanded .comment-expand-icon {
            transform: rotate(90deg);
        }
        .comment-content {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #dee2e6;
            display: none;
        }
        .comment-bar.expanded .comment-content {
            display: block;
        }
        .comment-loading {
            text-align: center;
            color: #6c757d;
            padding: 10px;
        }
        .status-pending { background-color: #ffc107; }
        .status-in_progress { background-color: #0dcaf0; }
        .status-completed { background-color: #198754; }
        .formatted-text {
            word-wrap: break-word;
        }
        .formatted-text p {
            margin: 0 0 0.5rem 0;
        }
        .formatted-text p:last-child {
            margin-bottom: 0;
        }
        .formatted-text p:only-child {
            margin-bottom: 0;
        }
        .formatted-text ul, .formatted-text ol {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }
        .formatted-text li {
            margin: 0.25rem 0;
        }
        .formatted-text a {
            color: #0d6efd;
            text-decoration: underline;
        }
        .formatted-text code {
            background: #f5f5f5;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 0.9em;
        }
        .formatted-text pre {
            background: #f5f5f5;
            padding: 8px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .formatted-text strong {
            font-weight: 600;
        }
        .formatted-text em {
            font-style: italic;
        }
        .formatted-text blockquote {
            border-left: 3px solid #ddd;
            padding-left: 12px;
            margin: 0.5rem 0;
            color: #6c757d;
        }
        .format-help {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary mb-4">
        <div class="container-fluid">
            <a href="{{ url_for('index') }}" class="navbar-brand">
                <i class="bi bi-arrow-left"></i> Back to Projects
            </a>
        </div>
    </nav>

    <div class="container">
        <!-- Project Header -->
        <div class="row mb-4">
            <div class="col-md-8">
                <h2>
                    {% if project.icon_data %}
                        <img src="data:image/png;base64,{{ project.icon_data }}" alt="Project Icon" style="width: 32px; height: 32px; margin-right: 10px; vertical-align: middle; image-rendering: pixelated;">
                    {% else %}
                        <i class="bi bi-folder-open text-primary"></i>
                    {% endif %}
                    {{ project.name }}
                </h2>
                {% if project.description %}
                <div class="text-muted formatted-text">{{ project.description | markdown | safe }}</div>
                {% else %}
                <p class="text-muted">No description</p>
                {% endif %}
                <span class="badge bg-success">{{ project.status }}</span>
                <small class="text-muted ms-2">Created: {{ project.created_at.split(' ')[0] }}</small>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-outline-secondary me-2" data-bs-toggle="modal" data-bs-target="#editProjectModal">
                    <i class="bi bi-pencil"></i> Edit Project
                </button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                    <i class="bi bi-plus-circle"></i> Add Task
                </button>
            </div>
        </div>

        <div class="row">
            <!-- Tasks Section -->
            <div class="col-md-8">
                <h4 class="mb-3">Tasks</h4>
                {% if tasks %}
                    {% for task in tasks %}
                    <div class="card mb-3 task-item">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h5 class="card-title">
                                        <i class="bi bi-check-circle"></i> {{ task.name }}
                                        <span class="badge status-{{ task.status }} ms-2">{{ task.status.replace('_', ' ').title() }}</span>
                                    </h5>
                                    {% if task.description %}
                                    <div class="card-text text-muted small formatted-text">{{ task.description | markdown | safe }}</div>
                                    {% else %}
                                    <p class="card-text text-muted small">No description</p>
                                    {% endif %}
                                    <div class="task-metadata">
                                        Created: {{ task.created_at.split(' ')[0] }}
                                        {% if task.id in task_last_comments %}
                                            {% set last_comment = task_last_comments[task.id] %}
                                            | Updated: {{ last_comment.created_at }}
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Progress Bar (only if task has subtasks) -->
                                    {% if task_progress[task.id] is not none %}
                                    <div class="task-progress">
                                        <div class="progress">
                                            <div class="progress-bar bg-success" role="progressbar" 
                                                 style="width: {{ task_progress[task.id] }}%"
                                                 aria-valuenow="{{ task_progress[task.id] }}" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="100">
                                            </div>
                                        </div>
                                        <small class="text-muted">{{ task_progress[task.id] }}% complete</small>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Subtasks Section -->
                                    {% if task.id in task_subtasks and task_subtasks[task.id] %}
                                    <div class="task-subtasks-section">
                                        <h6 class="mb-2 mt-2">Subtasks ({{ task_subtasks[task.id]|length }}):</h6>
                                        {% for subtask in task_subtasks[task.id] %}
                                        <div class="subtask-bar" data-subtask-id="{{ subtask.id }}">
                                            <div class="subtask-header" onclick="toggleSubtaskInline({{ subtask.id }})">
                                                <div class="subtask-title">
                                                    {{ subtask.name }}
                                                    <span class="badge status-{{ subtask.status }} ms-2">{{ subtask.status.replace('_', ' ').title() }}</span>
                                                </div>
                                                <div style="display: flex; align-items: center;">
                                                    <div class="subtask-actions">
                                                        <button class="btn btn-sm btn-outline-secondary" 
                                                                data-bs-toggle="modal" 
                                                                data-bs-target="#editSubtaskModal{{ subtask.id }}"
                                                                onclick="event.stopPropagation()"
                                                                title="Edit subtask">
                                                            <i class="bi bi-pencil"></i>
                                                        </button>
                                                        <div class="btn-group btn-group-sm">
                                                            <button class="btn btn-outline-info dropdown-toggle" 
                                                                    onclick="event.stopPropagation();"
                                                                    data-bs-toggle="dropdown">
                                                                <i class="bi bi-gear"></i>
                                                            </button>
                                                            <ul class="dropdown-menu">
                                                                <li><a class="dropdown-item" href="#" onclick="updateTaskStatus({{ subtask.id }}, 'pending')">Mark Pending</a></li>
                                                                <li><a class="dropdown-item" href="#" onclick="updateTaskStatus({{ subtask.id }}, 'in_progress')">Mark In Progress</a></li>
                                                                <li><a class="dropdown-item" href="#" onclick="updateTaskStatus({{ subtask.id }}, 'completed')">Mark Completed</a></li>
                                                            </ul>
                                                        </div>
                                                        <button class="btn btn-sm btn-outline-danger" 
                                                                onclick="event.stopPropagation(); deleteTask({{ subtask.id }})"
                                                                title="Delete subtask">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </div>
                                                    <i class="bi bi-chevron-right subtask-expand-icon"></i>
                                                </div>
                                            </div>
                                            <div class="subtask-content" id="subtask-content-{{ subtask.id }}">
                                                {% if subtask.description %}
                                                <div class="formatted-text small">{{ subtask.description | markdown | safe }}</div>
                                                {% else %}
                                                <p class="text-muted small">No description</p>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Last Comment Preview -->
                                    {% if task.id in task_last_comments %}
                                        {% set last_comment = task_last_comments[task.id] %}
                                        <div class="task-last-comment">
                                            <span class="task-last-comment-author">{{ last_comment.author }}:</span>
                                            <span class="task-last-comment-text">{{ last_comment.content | strip_markdown | truncate(100) }}</span>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-secondary" onclick="loadSubtasks({{ task.id }})" 
                                            data-bs-toggle="collapse" data-bs-target="#subtasks-{{ task.id }}">
                                        <i class="bi bi-list-nested"></i>
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="showAddSubtask({{ task.id }})">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                    <button class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#editTaskModal{{ task.id }}">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-info dropdown-toggle" data-bs-toggle="dropdown">
                                            <i class="bi bi-gear"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#" onclick="updateTaskStatus({{ task.id }}, 'pending')">Mark Pending</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="updateTaskStatus({{ task.id }}, 'in_progress')">Mark In Progress</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="updateTaskStatus({{ task.id }}, 'completed')">Mark Completed</a></li>
                                        </ul>
                                    </div>
                                    <button class="btn btn-outline-danger" onclick="deleteTask({{ task.id }})">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Subtasks Container -->
                            <div class="collapse mt-3" id="subtasks-{{ task.id }}">
                                <div id="subtasks-content-{{ task.id }}">
                                    <div class="text-center py-2">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> No tasks yet. Add your first task to get started!
                    </div>
                {% endif %}
            </div>

            <!-- Comments Section -->
            <div class="col-md-4">
                <h4 class="mb-3">Project Comments</h4>
                
                <!-- Add Comment Form -->
                <div class="card mb-3">
                    <div class="card-body">
                        <form id="projectCommentForm">
                            <input type="hidden" name="entity_type" value="project">
                            <input type="hidden" name="entity_id" value="{{ project.id }}">
                            <div class="mb-2">
                                <input type="text" class="form-control form-control-sm" name="author" placeholder="Your name" required>
                            </div>
                            <div class="mb-2">
                                <textarea class="form-control form-control-sm" name="content" rows="2" placeholder="Add a comment..." required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary btn-sm w-100">
                                <i class="bi bi-send"></i> Post Comment
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Comments List -->
                <div id="projectComments">
                    {% for comment in project_comments %}
                    <div class="comment-bar" data-comment-id="{{ comment.id }}">
                        <div class="comment-header" onclick="toggleComment({{ comment.id }})">
                            <div class="comment-title">
                                <div class="comment-title-text">
                                    <strong>{{ comment.author }}</strong>
                                    <small class="text-muted ms-2">{{ comment.created_at.split(' ')[0] }}</small>
                                </div>
                                <div class="comment-title-preview">{{ comment.content | strip_markdown | truncate(80) }}</div>
                            </div>
                            <div class="comment-header-right">
                                <div class="comment-actions">
                                    <button class="btn btn-sm btn-outline-secondary" 
                                            onclick="event.stopPropagation(); editComment({{ comment.id }})"
                                            title="Edit comment">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" 
                                            onclick="event.stopPropagation(); deleteComment({{ comment.id }})"
                                            title="Delete comment">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                                <i class="bi bi-chevron-right comment-expand-icon"></i>
                            </div>
                        </div>
                        <div class="comment-content" id="comment-content-{{ comment.id }}">
                            <div class="comment-loading">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div class="modal fade" id="addTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="{{ url_for('add_task') }}">
                    <input type="hidden" name="project_id" value="{{ project.id }}">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="taskName" class="form-label">Task Name *</label>
                            <input type="text" class="form-control" id="taskName" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="taskDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="taskDescription" name="description" rows="4"></textarea>
                            <div class="format-help">
                                <strong>Formatting:</strong> **bold**, *italic*, [link](url), `code`, - list | Two enters = new paragraph
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Task</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Project Modal -->
    <div class="modal fade" id="editProjectModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Project</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="{{ url_for('update_project', project_id=project.id) }}" enctype="multipart/form-data">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="editProjectName" class="form-label">Project Name *</label>
                            <input type="text" class="form-control" id="editProjectName" name="name" value="{{ project.name }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="editProjectDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="editProjectDescription" name="description" rows="4">{{ project.description or '' }}</textarea>
                            <div class="format-help">
                                <strong>Formatting:</strong> **bold**, *italic*, [link](url), `code`, - list | Two enters = new paragraph
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Current Icon</label>
                            <div class="mb-2">
                                {% if project.icon_data %}
                                    <img src="data:image/png;base64,{{ project.icon_data }}" alt="Current Icon" style="max-width: 32px; max-height: 32px; border: 1px solid #ddd; padding: 4px;">
                                {% else %}
                                    <i class="bi bi-folder" style="font-size: 32px;"></i>
                                {% endif %}
                            </div>
                            <label for="editProjectIcon" class="form-label">Upload New Icon (optional)</label>
                            <input type="file" class="form-control" id="editProjectIcon" name="icon" accept="image/png,image/jpeg,image/gif,image/svg+xml">
                            <small class="form-text text-muted">Leave empty to keep current icon</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Task Modals (one for each task) -->
    {% for task in tasks %}
    <div class="modal fade" id="editTaskModal{{ task.id }}" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="{{ url_for('update_task', task_id=task.id) }}">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="editTaskName{{ task.id }}" class="form-label">Task Name *</label>
                            <input type="text" class="form-control" id="editTaskName{{ task.id }}" name="name" value="{{ task.name }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="editTaskDescription{{ task.id }}" class="form-label">Description</label>
                            <textarea class="form-control" id="editTaskDescription{{ task.id }}" name="description" rows="4">{{ task.description or '' }}</textarea>
                            <div class="format-help">
                                <strong>Formatting:</strong> **bold**, *italic*, [link](url), `code`, - list | Two enters = new paragraph
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Edit Subtask Modals for this task -->
    {% if task.id in task_subtasks %}
        {% for subtask in task_subtasks[task.id] %}
        <div class="modal fade" id="editSubtaskModal{{ subtask.id }}" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Subtask</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form method="POST" action="{{ url_for('update_task', task_id=subtask.id) }}">
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="editSubtaskName{{ subtask.id }}" class="form-label">Subtask Name *</label>
                                <input type="text" class="form-control" id="editSubtaskName{{ subtask.id }}" name="name" value="{{ subtask.name }}" required>
                            </div>
                            <div class="mb-3">
                                <label for="editSubtaskDescription{{ subtask.id }}" class="form-label">Description</label>
                                <textarea class="form-control" id="editSubtaskDescription{{ subtask.id }}" name="description" rows="4">{{ subtask.description or '' }}</textarea>
                                <div class="format-help">
                                    <strong>Formatting:</strong> **bold**, *italic*, [link](url), `code`, - list | Two enters = new paragraph
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}
    {% endif %}
    {% endfor %}

    <!-- Add Subtask Modal -->
    <div class="modal fade" id="addSubtaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Subtask</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="{{ url_for('add_task') }}">
                    <input type="hidden" name="project_id" value="{{ project.id }}">
                    <input type="hidden" name="parent_task_id" id="parentTaskId">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="subtaskName" class="form-label">Subtask Name *</label>
                            <input type="text" class="form-control" id="subtaskName" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="subtaskDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="subtaskDescription" name="description" rows="4"></textarea>
                            <div class="format-help">
                                <strong>Formatting:</strong> **bold**, *italic*, [link](url), `code`, - list | Two enters = new paragraph
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Subtask</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Task Form (hidden) -->
    <form id="deleteTaskForm" method="POST" style="display: none;"></form>

    <!-- Edit Comment Modal -->
    <div class="modal fade" id="editCommentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Comment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editCommentId">
                    <div class="mb-3">
                        <label for="editCommentAuthor" class="form-label">Author Name *</label>
                        <input type="text" class="form-control" id="editCommentAuthor" required>
                    </div>
                    <div class="mb-3">
                        <label for="editCommentContent" class="form-label">Comment *</label>
                        <textarea class="form-control" id="editCommentContent" rows="6" required></textarea>
                        <div class="format-help">
                            <strong>Formatting:</strong> **bold**, *italic*, [link](url), `code`, - list | Two enters = new paragraph
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveCommentEdit()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        let loadedSubtasks = new Set();
        let loadedComments = new Set();

        // Configure marked for safe rendering
        marked.setOptions({
            breaks: false,
            gfm: true
        });

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function stripMarkdown(text) {
            if (!text) return '';
            // Remove markdown formatting for preview
            return text
                .replace(/\*\*(.+?)\*\*/g, '$1')  // Bold
                .replace(/\*(.+?)\*/g, '$1')      // Italic
                .replace(/`(.+?)`/g, '$1')        // Code
                .replace(/\[(.+?)\]\(.+?\)/g, '$1') // Links
                .replace(/^#+\s+/gm, '')          // Headers
                .replace(/^[-*+]\s+/gm, '')       // Lists
                .replace(/^\d+\.\s+/gm, '')       // Numbered lists
                .replace(/\n/g, ' ')              // Newlines to spaces
                .trim();
        }

        function formatMarkdown(text) {
            if (!text) return '';
            return marked.parse(text);
        }

        async function toggleComment(commentId) {
            const commentBar = document.querySelector(`.comment-bar[data-comment-id="${commentId}"]`);
            const contentDiv = document.getElementById(`comment-content-${commentId}`);
            
            // Toggle expanded state
            if (commentBar.classList.contains('expanded')) {
                commentBar.classList.remove('expanded');
                return;
            }
            
            commentBar.classList.add('expanded');
            
            // Load content if not already loaded
            if (!loadedComments.has(commentId)) {
                try {
                    const response = await fetch(`/comment/${commentId}`);
                    const data = await response.json();
                    
                    if (data.content) {
                        contentDiv.innerHTML = `<div class="formatted-text">${formatMarkdown(data.content)}</div>`;
                        loadedComments.add(commentId);
                    } else {
                        contentDiv.innerHTML = '<p class="text-muted small">No content</p>';
                    }
                } catch (error) {
                    contentDiv.innerHTML = '<p class="text-danger small">Error loading comment</p>';
                    console.error('Error loading comment:', error);
                }
            }
        }

        async function editComment(commentId) {
            try {
                // Fetch current comment data
                const response = await fetch(`/comment/${commentId}`);
                const data = await response.json();
                
                // Populate modal
                document.getElementById('editCommentId').value = commentId;
                document.getElementById('editCommentAuthor').value = data.author;
                document.getElementById('editCommentContent').value = data.content;
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('editCommentModal'));
                modal.show();
            } catch (error) {
                console.error('Error loading comment for edit:', error);
                alert('Error loading comment');
            }
        }

        async function saveCommentEdit() {
            const commentId = document.getElementById('editCommentId').value;
            const author = document.getElementById('editCommentAuthor').value;
            const content = document.getElementById('editCommentContent').value;
            
            if (!author || !content) {
                alert('Author and content are required');
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('author', author);
                formData.append('content', content);
                
                const response = await fetch(`/comment/${commentId}/update`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                if (result.success) {
                    // Close modal and reload page
                    bootstrap.Modal.getInstance(document.getElementById('editCommentModal')).hide();
                    location.reload();
                } else {
                    alert('Failed to update comment');
                }
            } catch (error) {
                console.error('Error updating comment:', error);
                alert('Error updating comment');
            }
        }

        async function deleteComment(commentId) {
            if (!confirm('Are you sure you want to delete this comment?')) {
                return;
            }
            
            try {
                const response = await fetch(`/comment/${commentId}/delete`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                if (result.success) {
                    location.reload();
                } else {
                    alert('Failed to delete comment');
                }
            } catch (error) {
                console.error('Error deleting comment:', error);
                alert('Error deleting comment');
            }
        }

        function loadSubtasks(taskId) {
            if (loadedSubtasks.has(taskId)) return;
            
            fetch(`/task/${taskId}/subtasks`)
                .then(response => response.json())
                .then(data => {
                    loadedSubtasks.add(taskId);
                    const container = document.getElementById(`subtasks-content-${taskId}`);
                    let html = '';
                    
                    if (data.subtasks.length > 0) {
                        html += '<div class="task-subtasks-section">';
                        data.subtasks.forEach(subtask => {
                            html += `
                                <div class="subtask-bar" data-subtask-id="${subtask.id}">
                                    <div class="subtask-header" onclick="toggleSubtask(${subtask.id})">
                                        <div class="subtask-title">
                                            ${escapeHtml(subtask.name)}
                                            <span class="badge status-${subtask.status} ms-2">${subtask.status.replace('_', ' ')}</span>
                                        </div>
                                        <div style="display: flex; align-items: center;">
                                            <div class="subtask-actions">
                                                <button class="btn btn-sm btn-outline-secondary" 
                                                        onclick="event.stopPropagation(); editSubtask(${subtask.id})"
                                                        title="Edit subtask">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-info dropdown-toggle" 
                                                            onclick="event.stopPropagation();"
                                                            data-bs-toggle="dropdown">
                                                        <i class="bi bi-gear"></i>
                                                    </button>
                                                    <ul class="dropdown-menu">
                                                        <li><a class="dropdown-item" href="#" onclick="updateTaskStatus(${subtask.id}, 'pending')">Mark Pending</a></li>
                                                        <li><a class="dropdown-item" href="#" onclick="updateTaskStatus(${subtask.id}, 'in_progress')">Mark In Progress</a></li>
                                                        <li><a class="dropdown-item" href="#" onclick="updateTaskStatus(${subtask.id}, 'completed')">Mark Completed</a></li>
                                                    </ul>
                                                </div>
                                                <button class="btn btn-sm btn-outline-danger" 
                                                        onclick="event.stopPropagation(); deleteTask(${subtask.id})"
                                                        title="Delete subtask">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                            <i class="bi bi-chevron-right subtask-expand-icon"></i>
                                        </div>
                                    </div>
                                    <div class="subtask-content" id="subtask-content-${subtask.id}">
                                        ${subtask.description ? `<div class="formatted-text small">${formatMarkdown(subtask.description)}</div>` : '<p class="text-muted small">No description</p>'}
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                    } else {
                        html += '<p class="text-muted small">No subtasks yet</p>';
                    }
                    
                    html += '<h6 class="mt-3 mb-2">Comments:</h6>';
                    html += `
                        <form class="task-comment-form mb-2" data-task-id="${taskId}">
                            <input type="hidden" name="entity_type" value="task">
                            <input type="hidden" name="entity_id" value="${taskId}">
                            <input type="text" class="form-control form-control-sm mb-1" name="author" placeholder="Your name" required>
                            <textarea class="form-control form-control-sm mb-1" name="content" rows="2" placeholder="Add comment..." required></textarea>
                            <button type="submit" class="btn btn-sm btn-primary">Post</button>
                        </form>
                    `;
                    
                    if (data.comments.length > 0) {
                        data.comments.forEach(comment => {
                            const plainText = stripMarkdown(comment.content);
                            const preview = plainText.substring(0, 80) + (plainText.length > 80 ? '...' : '');
                            html += `
                                <div class="comment-bar" data-comment-id="${comment.id}">
                                    <div class="comment-header" onclick="toggleComment(${comment.id})">
                                        <div class="comment-title">
                                            <div class="comment-title-text">
                                                <strong>${escapeHtml(comment.author)}</strong>
                                                <small class="text-muted ms-2">${comment.created_at.split(' ')[0]}</small>
                                            </div>
                                            <div class="comment-title-preview">${escapeHtml(preview)}</div>
                                        </div>
                                        <div class="comment-header-right">
                                            <div class="comment-actions">
                                                <button class="btn btn-sm btn-outline-secondary" 
                                                        onclick="event.stopPropagation(); editComment(${comment.id})"
                                                        title="Edit comment">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" 
                                                        onclick="event.stopPropagation(); deleteComment(${comment.id})"
                                                        title="Delete comment">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                            <i class="bi bi-chevron-right comment-expand-icon"></i>
                                        </div>
                                    </div>
                                    <div class="comment-content" id="comment-content-${comment.id}">
                                        <div class="formatted-text small">${formatMarkdown(comment.content)}</div>
                                    </div>
                                </div>
                            `;
                            // Mark as loaded since we already have the content
                            loadedComments.add(comment.id);
                        });
                    }
                    
                    container.innerHTML = html;
                    
                    // Add event listeners to task comment forms
                    container.querySelectorAll('.task-comment-form').forEach(form => {
                        form.addEventListener('submit', handleTaskCommentSubmit);
                    });
                });
        }

        function toggleSubtask(subtaskId) {
            const subtaskBar = document.querySelector(`.subtask-bar[data-subtask-id="${subtaskId}"]`);
            subtaskBar.classList.toggle('expanded');
        }

        function toggleSubtaskInline(subtaskId) {
            const subtaskBar = document.querySelector(`.subtask-bar[data-subtask-id="${subtaskId}"]`);
            subtaskBar.classList.toggle('expanded');
        }

        async function editSubtask(subtaskId) {
            try {
                const response = await fetch(`/task/${subtaskId}/subtasks`);
                const data = await response.json();
                
                // Get subtask data (it will be in the parent task's subtasks)
                // For simplicity, we'll reload and edit via modal
                // Create a modal similar to edit task
                const subtaskData = data.subtasks ? data.subtasks.find(s => s.id === subtaskId) : null;
                
                // For now, redirect to standard edit (we can enhance this with a modal later)
                const name = prompt('Subtask name:', subtaskData ? subtaskData.name : '');
                if (!name) return;
                
                const description = prompt('Description:', subtaskData ? subtaskData.description : '');
                
                const formData = new FormData();
                formData.append('name', name);
                formData.append('description', description || '');
                
                const updateResponse = await fetch(`/task/${subtaskId}/update`, {
                    method: 'POST',
                    body: formData
                });
                
                if (updateResponse.ok) {
                    location.reload();
                }
            } catch (error) {
                console.error('Error editing subtask:', error);
                alert('Error editing subtask');
            }
        }

        function showAddSubtask(taskId) {
            document.getElementById('parentTaskId').value = taskId;
            new bootstrap.Modal(document.getElementById('addSubtaskModal')).show();
        }

        function updateTaskStatus(taskId, status) {
            const formData = new FormData();
            formData.append('status', status);
            
            fetch(`/task/${taskId}/update-status`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            });
        }

        function deleteTask(taskId) {
            if (confirm('Delete this task? This will also delete all subtasks.')) {
                const form = document.getElementById('deleteTaskForm');
                form.action = `/task/${taskId}/delete`;
                form.submit();
            }
        }

        // Handle project comment submission
        document.getElementById('projectCommentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            fetch('/comment/add', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            });
        });

        function handleTaskCommentSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            fetch('/comment/add', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const taskId = e.target.dataset.taskId;
                    loadedSubtasks.delete(parseInt(taskId));
                    loadSubtasks(parseInt(taskId));
                }
            });
        }
    </script>
</body>
</html>
